<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

	<!-- 회원가입 insert -->
	<insert id="insertMember" parameterType="com.spring.board_fubao.model.MemberVO">
		insert into TBL_MEMBER (id, nickname, name, pwd, birthday, registerday, mobile,
				status, role)
		values (#{id}, #{nickname}, #{name}, #{pwd}, #{birthday}, default, #{mobile}, default, default)
	</insert>
		
	<!-- 아이디 중복 검사 -->
	<select id="id_check" parameterType="String" resultType="int">
	 	select count(*) from TBL_MEMBER where id=#{id}
	</select>
	
	<!-- 닉네임 중복 검사 -->
	<select id="nickname_check" parameterType="String" resultType="int">
	 	select count(*) from TBL_MEMBER where nickname=#{nickname}
	</select>

	<!-- 로그인처리 -->
	<select id="get_login_member" parameterType="HashMap" resultType="com.spring.board_fubao.model.MemberVO">
		select id, nickname, name, birthday, registerday, mobile, status, role
		from tbl_member
		where id = #{id} and pwd = #{pwd}
	</select>

	<!-- 게시글쓰기 -->
	<insert id="write_end" parameterType="com.spring.board_fubao.model.BoardVO">
		insert into tbl_board (b_idx, id_fk, nickname, category_idx_fk, b_title,
		b_content, b_date, b_like, b_hit, b_status, c_cnt)
		values (b_idx.nextval, #{id_fk}, #{nickname}, #{category_idx_fk}, #{b_title},
		#{b_content}, default, 0, default, default, default)
	</insert>

	<!-- 카테고리별 게시글 목록 가져오기 -->
	<select id="get_category" resultType="com.spring.board_fubao.model.CategoryVO" parameterType="int">
		select *
		from TBL_CATEGORY
		where category_idx = #{category_idx}
	</select>
	
	<!-- 게시글목록 조회 -->
	<select id="get_boardList" resultType="com.spring.board_fubao.model.BoardVO" parameterType="HashMap">
	    SELECT b_idx, id_fk, nickname, category_idx_fk, b_title,
	           b_content,
	           CASE
	               WHEN to_char(b_date, 'yyyy-MM-dd') = to_char(#{sysdate}, 'yyyy-MM-dd') 
	               THEN to_char(b_date, 'hh24:mi')
	               ELSE to_char(b_date, 'yyyy-MM-dd')
	           END AS b_date,
	           b_like, b_hit, b_status, c_cnt
	    FROM tbl_board
	    WHERE category_idx_fk = #{category_idx} and b_status = 1
	    ORDER BY b_idx DESC
	</select>
	
	
	<!-- 글1개 조회하기-->
	<select id="getView" parameterType="HashMap" resultType="com.spring.board_fubao.model.BoardVO">
		select previousseq, previoussubject
		     , b_idx, id_fk, nickname, category_idx_fk, b_title, b_content, b_hit, b_date, b_like, c_cnt
		     , nextseq, nextsubject 
		from 
		(
		select lag(b_idx,1) over(order by b_idx desc) AS previousseq
		     , lag(b_title,1) over(order by b_idx desc) AS previoussubject
		     , b_idx, id_fk, nickname, b_title, b_content, b_hit
		     , to_char(b_date, 'yyyy-mm-dd hh24:mi:ss') as b_date 
		     , b_like , c_cnt , category_idx_fk
		     , lead(b_idx,1) over(order by b_idx desc) AS nextseq
		     , lead(b_title,1) over(order by b_idx desc) AS nextsubject 
		from tbl_board
		where b_status = 1 and category_idx_fk = #{category_idx}
		) V 
		where V.b_idx = #{b_idx}
	</select>
	
	<!-- 글조회수 1증가 하기 -->
	<update id="setAddReadCnt" parameterType="int">
		update tbl_board set b_hit = b_hit + 1
		where b_idx = #{b_idx}
	</update>
	
	
</mapper>